trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"

variables:
  PYTHON_VERSION: "3.11"
  DOCKER_IMAGE_NAME: "tradingbot"
  DOCKER_TAG: "$(Build.BuildId)"
  GITLEAKS_VERSION: "8.18.4"

steps:
  - checkout: self
    fetchDepth: 0

  - script: |
      set -e
      echo "Installing gitleaks v$(GITLEAKS_VERSION)"
      curl -sSL -o gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v$(GITLEAKS_VERSION)/gitleaks_$(GITLEAKS_VERSION)_linux_x64.tar.gz
      tar -xzf gitleaks.tar.gz gitleaks
      chmod +x ./gitleaks
      ./gitleaks version

      echo "Running gitleaks scan..."
      ./gitleaks detect --redact --config .gitleaks.toml --exit-code 1
    displayName: "Secret scan (gitleaks)"

  - task: UsePythonVersion@0
    inputs:
      versionSpec: "$(PYTHON_VERSION)"
    displayName: "Use Python $(PYTHON_VERSION)"

  - script: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
      pip install -r requirements-dev.txt
    displayName: "Install dependencies"

  - script: |
      ruff check .
    displayName: "Lint (ruff)"

  - script: |
      pytest -q
    displayName: "Run tests (pytest)"

  - script: |
      docker --version
      docker build -t $(DOCKER_IMAGE_NAME):$(DOCKER_TAG) .
    displayName: "Build Docker image"

  - script: |
      set -e
      echo "Installing gitleaks v$(GITLEAKS_VERSION)"
      curl -sSL -o gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v$(GITLEAKS_VERSION)/gitleaks_$(GITLEAKS_VERSION)_linux_x64.tar.gz
      tar -xzf gitleaks.tar.gz gitleaks
      chmod +x ./gitleaks
      ./gitleaks version

      echo "Running gitleaks scan..."
      ./gitleaks detect \
        --redact \
        --config .gitleaks.toml \
        --exit-code 1 \
        --report-format sarif \
        --report-path gitleaks.sarif
    displayName: "Secret scan (gitleaks)"

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: "gitleaks.sarif"
      ArtifactName: "gitleaks-report"
    condition: always()