trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  PYTHON_VERSION: "3.11"
  DOCKER_IMAGE_NAME: "tradingbot"
  DOCKER_TAG: "$(Build.BuildId)"
  GITLEAKS_VERSION: "8.18.4"

steps:
  - checkout: self
    fetchDepth: 0

  # -------------------------------------------------
  # Secret scanning (gitleaks) + SARIF artifact
  # -------------------------------------------------
  - script: |
      set -e

      echo "Installing gitleaks v$(GITLEAKS_VERSION)"
      curl -sSL -o gitleaks.tar.gz \
        https://github.com/gitleaks/gitleaks/releases/download/v$(GITLEAKS_VERSION)/gitleaks_$(GITLEAKS_VERSION)_linux_x64.tar.gz
      tar -xzf gitleaks.tar.gz gitleaks
      chmod +x gitleaks
      ./gitleaks version

      echo "Running gitleaks scan (writing SARIF report)..."
      set +e
      ./gitleaks detect \
        --redact \
        --config .gitleaks.toml \
        --report-format sarif \
        --report-path gitleaks.sarif
      GITLEAKS_EXIT=$?
      set -e

      echo "Gitleaks exit code: $GITLEAKS_EXIT"

      # Ensure the SARIF file exists so artifact publishing never fails
      if [ ! -f gitleaks.sarif ]; then
        echo "Creating empty SARIF placeholder"
        echo '{"$schema":"https://json.schemastore.org/sarif-2.1.0.json","version":"2.1.0","runs":[]}' > gitleaks.sarif
      fi

      # Fail if leaks were found (exit 1) or if gitleaks errored (exit 2+)
      if [ "$GITLEAKS_EXIT" -ne 0 ]; then
        echo "Gitleaks detected leaks (or encountered an error). Failing the job."
        exit $GITLEAKS_EXIT
      fi
    displayName: "Secret scan (gitleaks)"

  - task: PublishBuildArtifacts@1
    displayName: "Publish gitleaks report"
    condition: always()
    inputs:
      PathtoPublish: gitleaks.sarif
      ArtifactName: gitleaks-report

  # -------------------------------------------------
  # Python environment
  # -------------------------------------------------
  - task: UsePythonVersion@0
    displayName: "Use Python $(PYTHON_VERSION)"
    inputs:
      versionSpec: "$(PYTHON_VERSION)"

  - script: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
      pip install -r requirements-dev.txt
    displayName: "Install dependencies"

  # -------------------------------------------------
  # Code quality
  # -------------------------------------------------
  - script: |
      ruff format --check .
    displayName: "Format check (ruff)"

  - script: |
      ruff check .
    displayName: "Lint (ruff)"

  - script: |
      mypy --explicit-package-bases src
    displayName: "Type check (mypy)"

  # -------------------------------------------------
  # Tests + coverage
  # -------------------------------------------------
  - script: |
      pytest -q --cov=src --cov-report=term-missing --cov-fail-under=40
    displayName: "Run tests with coverage"

  # -------------------------------------------------
  # Dependency security scan
  # -------------------------------------------------
  - script: |
      pip-audit -r requirements.txt
    displayName: "Dependency vulnerability scan (pip-audit)"

  # -------------------------------------------------
  # Docker build
  # -------------------------------------------------
  - script: |
      docker --version
      docker build -t $(DOCKER_IMAGE_NAME):$(DOCKER_TAG) .
    displayName: "Build Docker image"

  # -------------------------------------------------
  # github sync
  # -------------------------------------------------
    stages:
  - stage: MirrorToGitHub
    displayName: "Mirror repo to GitHub (read-only)"
    jobs:
  - job: mirror
    displayName: "Push main to GitHub"
    pool:
      vmImage: ubuntu-latest
    variables:
    - group: github-mirror
    steps:
    - checkout: self
      persistCredentials: true

    - script: |
        set -e

        git config --global user.email "mirror@devops.local"
        git config --global user.name "Azure DevOps Mirror"

        git remote add github https://$(GITHUB_PAT)@github.com/comtourist/tradingbot-public-mirror.git

        git push --force github HEAD:main
      displayName: "Mirror main branch to GitHub"