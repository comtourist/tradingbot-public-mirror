trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"

variables:
  PYTHON_VERSION: "3.11"
  DOCKER_IMAGE_NAME: "tradingbot"
  DOCKER_TAG: "$(Build.BuildId)"
  GITLEAKS_VERSION: "8.18.4"

steps:
  - checkout: self
    fetchDepth: 0

  - script: |
      set -e
      echo "Installing gitleaks v$(GITLEAKS_VERSION)"
      curl -sSL -o gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v$(GITLEAKS_VERSION)/gitleaks_$(GITLEAKS_VERSION)_linux_x64.tar.gz
      tar -xzf gitleaks.tar.gz gitleaks
      chmod +x ./gitleaks
      ./gitleaks version

      echo "Running gitleaks scan (writing SARIF report)..."
      # Run without failing immediately so the report is created even when leaks exist
      set +e
      ./gitleaks detect \
        --redact \
        --config .gitleaks.toml \
        --report-format sarif \
        --report-path gitleaks.sarif
      GITLEAKS_EXIT=$?
      set -e

      echo "Gitleaks exit code: $GITLEAKS_EXIT"
      # Exit 1 if leaks found (gitleaks uses exit code 1 for findings)
      if [ "$GITLEAKS_EXIT" -ne 0 ]; then
        echo "Gitleaks detected leaks (or encountered an error). Failing the job."
        exit $GITLEAKS_EXIT
      fi
    displayName: "Secret scan (gitleaks)"

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: "gitleaks.sarif"
      ArtifactName: "gitleaks-report"
    condition: and(always(), exists('gitleaks.sarif'))
    displayName: "Publish gitleaks report"

  - task: UsePythonVersion@0
    inputs:
      versionSpec: "$(PYTHON_VERSION)"
    displayName: "Use Python $(PYTHON_VERSION)"

  - script: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
      pip install -r requirements-dev.txt
    displayName: "Install dependencies"

  - script: |
      ruff check .
    displayName: "Lint (ruff)"

  - script: |
      pytest -q
    displayName: "Run tests (pytest)"

  - script: |
      docker --version
      docker build -t $(DOCKER_IMAGE_NAME):$(DOCKER_TAG) .
    displayName: "Build Docker image"